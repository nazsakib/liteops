name: Build & Release
on:
    push:
        branches: [main]

jobs:
    build:
        runs-on: ubuntu-latest
        permissions:
            contents: write # Ensures the bot can commit and push version.json
        steps:
            - uses: actions/checkout@v4

            - name: Setup Java
              uses: actions/setup-java@v3
              with:
                  distribution: "zulu"
                  java-version: "17"

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: "stable"

            - name: Build APK
              run: flutter build apk --release --build-number=${{ github.run_number }}

            - name: Create Release
              id: create_release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: v${{ github.run_number }}
                  name: LiteOps v${{ github.run_number }}
                  files: build/app/outputs/flutter-apk/app-release.apk
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Update Version JSON
              run: |
                  # Create public folder if it doesn't exist
                  mkdir -p public

                  # Update the JSON inside the public folder for Vercel deployment
                  echo '{"version": "${{ github.run_number }}", "url": "https://github.com/${{ github.repository }}/releases/download/v${{ github.run_number }}/app-release.apk"}' > public/version.json

                  git config --global user.name "github-actions"
                  git config --global user.email "action@github.com"
                  git add public/version.json

                  # Only commit and push if there is a change to avoid errors
                  git diff --quiet && git diff --staged --quiet || (git commit -m "Update version to ${{ github.run_number }} [skip ci]" && git push)
